#!/usr/bin/env node

"use strict";

const commander = require("commander");

const cli = require("../lib/cli");
const { defaultLogger, getLogger } = require("../lib/logger");

const pkg = require("../package.json");

defaultLogger.level = "all";
const logger = getLogger("cli");

/**
 * Handles uncaught error: prints error and exits with code 1.
 * @param {*} err
 * @returns {void}
 */
function handleUncaughtError(err) {
  if (err && err.stack) {
    logger.error(`Command failed:\n${err.stack}`);
  } else {
    logger.error(`Command failed:\n${err}`);
  }
  process.exit(1);
}

let handled = false;

commander
  .command("init")
  .description("initialize a project")
  .action(() => {
    handled = true;
    const cwd = process.cwd();
    cli.init(cwd).catch(handleUncaughtError);
  });

commander
  .command("run <profile> [glob...]")
  .description("run tasks")
  .option("-C, --max-concurrency <int>", "maximum number of concurrent workers", parseInt)
  .action((profileName, globs, command) => {
    handled = true;
    const cwd = process.cwd();
    const opts = {
      maxConcurrency: command.maxConcurrency,
    };
    cli.run(cwd, profileName, globs, opts).catch(handleUncaughtError);
  });

commander
  .version(pkg["version"], "-v, --version")
  .parse(process.argv);

if (!handled) {
  commander.help();
}
